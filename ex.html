<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" type="text/css" href="css/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="bower_components/shepherd/css/shepherd-theme-default.css">
    <link rel="stylesheet" href="bower_components/shepherd/css/shepherd-theme-arrows.css">
    <link rel="stylesheet" href="bower_components/quill/dist/quill.snow.css">
    
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="bower_components/shepherd/shepherd.js"></script>
    <script type="text/javascript" src="js/angular.min.js"></script>
    <script type="text/javascript" src="bower_components/quill/dist/quill.min.js"></script>
    <script type="text/javascript" src="bower_components/ngquill/src/ng-quill.min.js"></script>

    <style>
    #formHTML .guiderInput{
    	display: none;
    }

    .shepherd-text span.variableDisp{
    	display: none;
    }
    </style>

    <script>
	tour = new Shepherd.Tour({
	  defaults: {
	    classes: 'shepherd-theme-arrows',
	    scrollTo: true
	  }
	});
    </script>
</head>

<body ng-app="myapp">
<div class="container" style="margin-left: 125px;">
	<div ng-controller="MainController">
	    <h2>Template Button</h2>

	    <button onclick="tour.start()">Tour</button>

	    <ng-quill-editor ng-model="html1" toolbar="true" link-tooltip="true" image-tooltip="true" toolbar-entries="font size bold list bullet italic underline strike align color background link image" editor-required="true" required="" error-class="input-error"></ng-quill-editor>

	    <h2>Form</h2>
	    <div id="formGen" compile-html="html2"></div>
	    
	    <h2>Result</h2>
	    <div id="formHTML" compile-html="html3"></div>
	</div>

</div>





<script>
angular.module("myapp", ['ngQuill'])
	.service('dataService', function(){
		this.users = [];
		this.name = "s";
		window.dataService = this;
	})
    .controller("MainController", function($scope, $interpolate, $sce, $interval, dataService) {
        $scope.helloTo = {};
        $scope.helloTo.title = "World, AngularJS";
        $scope.html1 = "";
        $scope.html2 = "";
        $scope.html3 = "";
        window.scope = $scope;
        $scope.dataService = dataService;

        $scope.parseVariables = function(html) {
        	var re = /\{\{(\w+)\}\}/g;
        	var res = html.match(re);
        	for(var i in res)
        		res[i] = res[i].replace(/[\{\}]/g,'')
        	return res;
        }

        $scope.generateForm = function(variables) {
        	var html = "";
        	
        	for(var i in variables){
        		html += '<label>' + variables[i] + ':</label>'
                html += '<input type="text" ng-model="' + variables[i] + '">';
        	}
        	//console.log(html);
        	return html;
        }

        $scope.generateText = function() {
        	var decodedText = $scope.decodeHtml($scope.html1);
        	console.log(decodedText);
        	$scope.html3 = $sce.trustAsHtml($interpolate(decodedText)($scope));	
        }

        $scope.decodeHtml = function (html) {
		    var txt = document.createElement("textarea");
		    txt.innerHTML = html;
		    return txt.value;
		}

        $scope.$watch('html1', function() {
        	//console.log($scope.variables)
        	var variables = $scope.parseVariables($scope.html1);
        	$scope.generateText();
        });

        $interval(function(){
        	$scope.generateText();
        }, 50)
    } )
	.directive('compileHtml',['$sce', '$parse', '$compile', function($sce, $parse, $compile){
	  return {
	    link: function(scope,element,attr){
	      var parsed = $parse(attr.compileHtml);
	      function getStringValue() { return (parsed(scope) || '').toString(); }            
	      scope.$watch(getStringValue, function (value) {
	        var el = $compile($sce.getTrustedHtml(parsed(scope)) || '')(scope);
	        element.empty();
	        element.append(el);        
	      });       
	    } 
	  };
	}])
	.directive('guider',['$sce', '$parse', '$compile', '$timeout', function($sce, $parse, $compile, $timeout){
	  return {
	  	restrict: 'E',
	  	scope: true,
	    link: function(scope, element, attr) {
	      debugger;
	      var $el = $("<form></form>");
	      // Strip non form tags and compile
	      $el.append(element.find(".guiderInput"));
	      $compile($el.contents())(scope);
	      //console.log(html);
	      $timeout(function(){
	      	tour.addStep('myStep', {
			  title: attr.description,
			  scrollTo: true,
			  text: $el[0],
			  attachTo: {element: element[0], on: 'right'},
			  classes: 'shepherd shepherd-open shepherd-theme-arrows shepherd-transparent-text',
			  buttons: [
			  	{
			  		text: 'Back',
			  		classes: 'shepherd-button-example-primary',
			  		action: function() {
			  			return tour.back();
			  		}
			  	},
			    {
			      text: 'Next',
			      classes: 'shepherd-button-example-primary',
			      action: function() {
			        return tour.next();
			      }
			    }
			  ]
			});
	      }, 0)
	      
	    } 
	  };
	}])
	.directive('variable',['$compile', 'dataService', function($compile, dataService){
	  return {
	  	restrict: 'E',
	  	replace: true,
	  	scope: true,
	  	template: function(element, attr){
	  		//debugger;
	  		debugger;
	  		//console.log(!element.parent().parent().length)
	  		//if(!element.parent().parent().length)
	  		//	return element[0].outerHTML;
	  		//else
	  			return '<span><span class="guiderInput"><label for="' + attr.name +'">' + attr.question + '</label><input type="text" name="' + attr.name +'" ng-model="dataService.' + attr.name +'"/></span>' + '<span class="variableDisp" ng-bind="dataService.' + attr.name +'"></span></span>';
	  	},
	  	link: function(scope, element, attr){
	      console.log('i am alive!', dataService)
	      //$compile(element)(scope)
	      //alert('i am alive')
	      //	debugger;     
	    } 
	  };
	}]);
</script>

<script>
	$(function(){
		// tour.on('show', function(a,b,c){
		// 	debugger;
		// })
		tour.start();
	});
</script

</body>
</html>